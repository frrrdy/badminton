<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Auslosung</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
            --success: #22c55e;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 50px; }
        h2, h3 { margin-top: 0; }

        .container { max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Formular-Elemente */
        .flex-row { display: flex; 
    gap: 8px; /* Etwas schmalerer Abstand f√ºr Mobile */
    margin-bottom: 10px; 
    align-items: center; /* Zentriert Input und Button vertikal */ }
        input[type="text"], input[type="date"] { flex: 1; 
    min-width: 0; /* Verhindert, dass das Input-Feld den Container sprengt */
    padding: 12px; 
    border: 1px solid var(--border); 
    border-radius: 8px; 
    font-size: 16px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        button:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-add { background: var(--text); 
    color: white; 
    white-space: nowrap; /* Verhindert Zeilenumbruch im Button */
    padding: 12px 15px; /* Reduziertes seitliches Padding */
    flex-shrink: 0; /* Verhindert, dass der Button zusammengedr√ºckt wird */ }
        .btn-accept { background: var(--success); color: white; flex: 1; }
        .btn-reject { background: var(--danger); color: white; flex: 1; }

        /* Spielerliste */
        .player-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .player-item:last-child { border: none; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; font-size: 16px; }
        input[type="checkbox"] { width: 20px; height: 20px; }

        /* Platz-Konfig */
        .court-config { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        select { padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 14px; }

        /* Ergebnis & Historie */
        .match-display { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .pause-display { color: #64748b; font-style: italic; margin-top: 10px; }
        .history-entry { border-left: 3px solid var(--border); padding-left: 10px; margin-bottom: 20px; font-size: 14px; }
        .history-round { font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè∏ Badminton Auslosung</h2>

    <div class="card">
        <h3>Spieler (<span id="activeCount">0</span> aktiv)</h3>
        <div class="flex-row">
            <input type="text" id="playerName" placeholder="Name eingeben...">
            <button class="btn-add" id="btnAddPlayer">Hinzuf√ºgen</button>
        </div>
        <div id="playerList"></div>
    </div>

    <div class="card">
        <h3>Pl√§tze</h3>
        <div id="courtSettings">
            <div class="court-config"><span>Platz 1</span><select id="c1"><option value="4">Doppel (4)</option><option value="2">Einzel (2)</option><option value="0">Aus</option></select></div>
            <div class="court-config"><span>Platz 2</span><select id="c2"><option value="4">Doppel (4)</option><option value="2">Einzel (2)</option><option value="0">Aus</option></select></div>
            <div class="court-config"><span>Platz 3</span><select id="c3"><option value="4">Doppel (4)</option><option value="2">Einzel (2)</option><option value="0">Aus</option></select></div>
        </div>
        <button class="btn-primary" style="margin-top:10px;" id="btnDraw">Auslosen</button>
    </div>

    <div id="previewArea" class="card hidden">
        <h3>Vorschau</h3>
        <div id="matchPreview"></div>
        <div class="flex-row" style="margin-top:15px;">
            <button class="btn-reject" id="btnReject">Ablehnen</button>
            <button class="btn-accept" id="btnAccept">Akzeptieren</button>
        </div>
    </div>

    <div class="card">
        <div class="flex-row" style="align-items: center;">
            <h3 style="margin:0">Dokumentation</h3>
            <input type="date" id="docDate">
        </div>
        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
        <div id="historyList"></div>
    </div>
</div>

<script>
    // State Management
    let state = {
        players: [], // { name: string, active: bool, pauses: int }
        history: [], // { date: string, rounds: [] }
        currentDraft: null
    };

    // Initialisierung
    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('badmintonState');
        if (saved) {
            state = JSON.parse(saved);
        }
        document.getElementById('docDate').valueAsDate = new Date();
        renderPlayers();
        renderHistory();
        
        // Event Listeners (ohne innerHTML Zerst√∂rung)
        document.getElementById('btnAddPlayer').onclick = addPlayer;
        document.getElementById('btnDraw').onclick = drawMatches;
        document.getElementById('btnAccept').onclick = acceptDraw;
        document.getElementById('btnReject').onclick = drawMatches;
    });

    function save() {
        localStorage.setItem('badmintonState', JSON.stringify(state));
    }

    function addPlayer() {
        const input = document.getElementById('playerName');
        const name = input.value.trim();
        if (name) {
            state.players.push({ name, active: true, pauses: 0 });
            input.value = '';
            renderPlayers();
            save();
        }
    }

    function togglePlayer(index) {
        state.players[index].active = !state.players[index].active;
        renderPlayers();
        save();
    }

    function renderPlayers() {
        const list = document.getElementById('playerList');
        list.innerHTML = '';
        let activeCounter = 0;
        
        state.players.forEach((p, i) => {
            if(p.active) activeCounter++;
            const div = document.createElement('div');
            div.className = 'player-item';
            div.innerHTML = `
                <div class="checkbox-wrapper">
                    <input type="checkbox" ${p.active ? 'checked' : ''} onchange="togglePlayer(${i})">
                    <span>${p.name} (${p.pauses})</span>
                </div>
                <button onclick="removePlayer(${i})" style="background:none; color:var(--danger); padding:5px;">‚úï</button>
            `;
            list.appendChild(div);
        });
        document.getElementById('activeCount').innerText = activeCounter;
    }

    function removePlayer(index) {
        state.players.splice(index, 1);
        renderPlayers();
        save();
    }

 function drawMatches() {
    const activePlayers = state.players.filter(p => p.active);
    const courts = [
        parseInt(document.getElementById('c1').value),
        parseInt(document.getElementById('c2').value),
        parseInt(document.getElementById('c3').value)
    ];

    // Berechnung: Wie viele Spieler werden insgesamt f√ºr die Pl√§tze ben√∂tigt?
    const totalNeeded = courts.reduce((a, b) => a + b, 0);

    if (activePlayers.length < 2) {
        alert("Nicht gen√ºgend aktive Spieler!");
        return;
    }

    // --- FAIRNESS LOGIK ---
    // Wir sortieren so, dass Leute mit VIELEN Pausen oben stehen (Priorit√§t f√ºr das Spiel).
    // Leute mit WENIGEN Pausen landen unten im Pool und m√ºssen eher pausieren.
    let pool = [...activePlayers].sort((a, b) => {
        // Sortierung absteigend nach Pausen
        if (b.pauses !== a.pauses) {
            return b.pauses - a.pauses; 
        }
        // Bei gleicher Pausenzahl entscheidet der Zufall
        return Math.random() - 0.5;
    });

    let matches = [];
    
    // Wir f√ºllen die Pl√§tze nacheinander mit den Spielern, die am l√§ngsten nicht pausiert haben
    courts.forEach((size, index) => {
        if (size > 0 && pool.length >= size) {
            const team = pool.splice(0, size);
            
            if (size === 4) {
                matches.push({ type: 'Doppel', court: index + 1, p: team.map(t => t.name) });
            } else if (size === 2) {
                matches.push({ type: 'Einzel', court: index + 1, p: team.map(t => t.name) });
            }
        }
    });

    // Die √úbriggebliebenen im Pool sind die, die pausieren m√ºssen.
    // Da wir oben die mit den meisten Pausen zuerst rausgepickt haben,
    // bleiben hier die mit den wenigsten Pausen √ºbrig.
    const pausePlayers = pool.map(p => ({ name: p.name, total: p.pauses + 1 }));

    state.currentDraft = { matches, pauses: pausePlayers };
    showPreview(state.currentDraft);
}

    function showPreview(draft) {
        const area = document.getElementById('previewArea');
        const display = document.getElementById('matchPreview');
        area.classList.remove('hidden');
        
        display.innerHTML = draft.matches.map(m => `
            <div class="match-display">
                <strong>Platz ${m.court} (${m.type}):</strong><br>
                ${m.type === 'Doppel' ? `${m.p[0]} / ${m.p[1]} vs. ${m.p[2]} / ${m.p[3]}` : `${m.p[0]} vs. ${m.p[1]}`}
            </div>
        `).join('');

        if (draft.pauses.length > 0) {
            display.innerHTML += `<div class="pause-display">Pause: ${draft.pauses.map(p => `${p.name} (${p.total})`).join(', ')}</div>`;
        }
    }

    function acceptDraw() {
        if (!state.currentDraft) return;

        const date = document.getElementById('docDate').value;
        
        // Pausen-Z√§hler im Haupt-State erh√∂hen
        state.currentDraft.pauses.forEach(pp => {
            const player = state.players.find(p => p.name === pp.name);
            if (player) player.pauses++;
        });

        // In Historie speichern
        let dayEntry = state.history.find(h => h.date === date);
        if (!dayEntry) {
            dayEntry = { date: date, rounds: [] };
            state.history.push(dayEntry);
        }

        dayEntry.rounds.push({
            matches: state.currentDraft.matches,
            pauses: state.currentDraft.pauses
        });

        state.currentDraft = null;
        document.getElementById('previewArea').classList.add('hidden');
        renderPlayers();
        renderHistory();
        save();
    }

    function renderHistory() {
        const date = document.getElementById('docDate').value;
        const list = document.getElementById('historyList');
        list.innerHTML = '';

        const dayEntry = state.history.find(h => h.date === date);
        if (!dayEntry || dayEntry.rounds.length === 0) {
            list.innerHTML = '<p style="color:#64748b">Noch keine Runden f√ºr heute.</p>';
            return;
        }

        [...dayEntry.rounds].reverse().forEach((r, i) => {
            const div = document.createElement('div');
            div.className = 'history-entry';
            const roundNum = dayEntry.rounds.length - i;
            
            let html = `<span class="history-round">Runde ${roundNum}</span>`;
            r.matches.forEach(m => {
                html += `<div>Pl. ${m.court}: ${m.type === 'Doppel' ? `${m.p[0]}/${m.p[1]} vs ${m.p[2]}/${m.p[3]}` : `${m.p[0]} vs ${m.p[1]}`}</div>`;
            });
            if(r.pauses.length > 0) {
                html += `<div style="color:#64748b">Pause: ${r.pauses.map(p => `${p.name}(${p.total})`).join(', ')}</div>`;
            }
            div.innerHTML = html;
            list.appendChild(div);
        });
    }

    // Datum-Wechsel Update
    document.getElementById('docDate').onchange = renderHistory;
</script>

</body>
</html>
